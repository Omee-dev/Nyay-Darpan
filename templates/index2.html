<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Consumer Case</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    body {
      font-family: "Inter", Arial, sans-serif;
      background: #f5faf7;
      margin: 0;
      padding: 40px 20px;
      color: #2e3b32;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 35px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2d593f;
    }
    .drop-area {
      border: 2px dashed #3cb371;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      color: #4b6152;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
      background: #f9fefb;
    }
    .drop-area.dragover {
      background: #e3f8ec;
      border-color: #2e8b57;
      color: #2e8b57;
    }
    textarea {
      width: 100%;
      height: 150px;
      margin-top: 20px;
      padding: 12px;
      border: 1px solid #cfd8d1;
      border-radius: 8px;
      resize: vertical;
      font-size: 14px;
      background: #fafdfb;
      color: #2e3b32;
    }
    .submit-btn {
      margin-top: 25px;
      padding: 14px 20px;
      background: #3cb371;
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s ease;
    }
    .submit-btn:hover {
      background: #2e8b57;
    }
    .model-select, .upload-mode {
      margin-top: 20px;
      text-align: center;
    }
    label {
      font-weight: 500;
      margin-right: 8px;
    }
    select {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #cfd8d1;
      background: #f9fefb;
      color: #2e3b32;
    }
    .file-list {
      margin-top: 15px;
    }
    .file-item {
      margin-bottom: 8px;
      padding: 10px;
      border-radius: 8px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
      cursor: pointer;
    }
    .file-item:hover {
      background: #f0f9f4;
    }
    .delete-btn {
      margin-left: 10px;
      color: red;
      cursor: pointer;
      font-weight: bold;
    }
    .preview-popup {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 5px;
      border: 1px solid #ccc;
      background: white;
      padding: 5px;
      z-index: 10;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .preview-popup canvas {
      max-width: 200px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
    <h1 style="text-align:center; margin-top:20px;">Decision Assist Tool</h1>
    <!-- Progress Bar -->
<div id="progressContainer" style="display:none; width:100%; background-color:#f3f3f3; margin-top:10px; border-radius:5px;">
  <div id="progressBar" style="width:0%; height:20px; background-color:#4CAF50; border-radius:5px;"></div>
</div>
<div class="container">
  <h2>Upload or Paste Consumer Case</h2>
  <form method="post" enctype="multipart/form-data" id="caseForm">
    <input type="file" id="fileInput" name="case_file" multiple hidden>
    <div id="dropArea" class="drop-area">üìÇ Drag & Drop File(s) Here or Click to Browse</div>

    <!-- File list -->
    <div id="fileList" class="file-list"></div>

    <!-- Upload mode toggle -->
    <div class="upload-mode">
      <label><input type="radio" name="upload_mode" value="normal" checked> Normal Upload</label>
      <label><input type="radio" name="upload_mode" value="ocr"> OCR Upload</label>
    </div>

    <!-- Case text (only in normal mode) -->
    <textarea id="caseText" name="case_text" placeholder="Or paste the case text here..."></textarea>

    <div class="model-select">
      <label for="model">Choose Model:</label>
      <select name="model" id="model">
        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
        <option value="meta-llama/Llama-3.1-8B-Instruct">Llama 3.1</option>
      </select>
    </div>
    <button class="submit-btn" type="submit">‚ú® Generate Summary</button>
  </form>
</div>


<script>
    document.getElementById('caseForm').addEventListener('submit', function(e) {
    // Show progress container
    document.getElementById('progressContainer').style.display = 'block';

    // Animate progress bar
    let width = 0;
    let interval = setInterval(() => {
        if (width >= 90) { // Stop at 90%, server will finish the rest
            clearInterval(interval);
        } else {
            width += 5;
            document.getElementById('progressBar').style.width = width + '%';
        }
    }, 200); // update every 200ms
});
  const dropArea = document.getElementById('dropArea');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const caseText = document.getElementById('caseText');
  const uploadModeRadios = document.getElementsByName('upload_mode');
  const caseForm = document.getElementById("caseForm"); // form element
  let uploadedFiles = [];

  // Set file input accept based on mode
  function updateFileAccept() {
    const mode = document.querySelector('input[name="upload_mode"]:checked').value;
    fileInput.value = ''; // reset
    if (mode === "ocr") {
      fileInput.accept = ".pdf";
      caseText.style.display = "none";
    } else {
      fileInput.accept = ".pdf,.txt,.docx";
      caseText.style.display = "block";
    }
  }

  // Render file list
  function renderFileList() {
    fileList.innerHTML = '';
    uploadedFiles.forEach((file, idx) => {
      const div = document.createElement('div');
      div.className = 'file-item';
      div.innerHTML = `
        <span>${file.name} (${(file.size/1024).toFixed(1)} KB)</span>
        <span class="delete-btn" data-idx="${idx}">‚ùå</span>
        <div class="preview-popup" id="preview-${idx}"><canvas></canvas></div>
      `;
      
      // Click = open in new tab
      div.addEventListener('click', (e) => {
        if (!e.target.classList.contains('delete-btn')) {
          const url = URL.createObjectURL(file);
          window.open(url, '_blank');
        }
      });

      // Hover = preview first page (PDF only)
      if (file.type === "application/pdf") {
        div.addEventListener('mouseenter', () => showPdfPreview(file, idx));
        div.addEventListener('mouseleave', () => {
          document.getElementById(`preview-${idx}`).style.display = "none";
        });
      }

      fileList.appendChild(div);
    });

    // Delete handler
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(e.target.dataset.idx);
        uploadedFiles.splice(index, 1);
        renderFileList();
      });
    });
  }

  // PDF preview with pdf.js
  async function showPdfPreview(file, idx) {
    const previewDiv = document.getElementById(`preview-${idx}`);
    previewDiv.style.display = 'block';
    const canvas = previewDiv.querySelector('canvas');
    const url = URL.createObjectURL(file);
    const pdf = await pdfjsLib.getDocument(url).promise;
    const page = await pdf.getPage(1);
    const viewport = page.getViewport({ scale: 0.3 });
    const context = canvas.getContext('2d');
    canvas.height = viewport.height;
    canvas.width = viewport.width;
    await page.render({ canvasContext: context, viewport }).promise;
  }

  // Add new files (stacking)
  function addFiles(files) {
    uploadedFiles = uploadedFiles.concat(Array.from(files));
    renderFileList();
  }

  // Drag and drop
  dropArea.addEventListener('click', () => fileInput.click());
  dropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropArea.classList.add('dragover');
  });
  dropArea.addEventListener('dragleave', () => {
    dropArea.classList.remove('dragover');
  });
  dropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    addFiles(e.dataTransfer.files);
  });

  // File input change
  fileInput.addEventListener('change', () => {
    addFiles(fileInput.files);
  });

  // Mode toggle
  uploadModeRadios.forEach(radio => {
    radio.addEventListener('change', updateFileAccept);
  });

  updateFileAccept(); // init

  // ‚úÖ Patch: ensure all files in uploadedFiles array are submitted
  caseForm.addEventListener("submit", (e) => {
    const dt = new DataTransfer();
    uploadedFiles.forEach(f => dt.items.add(f));
    fileInput.files = dt.files;
  });
</script>

</body>
</html>
